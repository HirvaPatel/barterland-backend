/* Author : Vikram Babu Rajendran */

const express = require("express");
const req = require("express/lib/request");
const res = require("express/lib/response");


const router = express.Router();

var mongo = require('../mongo');

// Connect to the DB; To use with all the API's
mongo.connectDB(async (err) => {
    if (err) throw err;

    // Get All the deals made by the user. 
    // Input : user_id [ in header ]
    // Output : List of deals.
    router.get("/mydeals", (req, res) => {

        const user_id = req.headers.user_id;
        const db = mongo.getDatabase();

        // Parse through all the Ads and filter the deals with the given user_id
        db.collection('advertisments').aggregate([{
            $project: {
                _id: 0,
                ad_details: 1,
                ad_id: 1,
                user_id: 1,
                "deals": {
                    $filter: {
                        input: "$deals",
                        as: "deals",
                        cond: {
                            $eq: ["$$deals.user_id", user_id]
                        }
                    }
                }
            }
        }]).toArray().then(results => {
            console.log(results);
            let finalResult = []
            results.forEach(r => {
                if (r.deals.length > 0) {
                    const deals = r.deals.slice().reverse();
                    for (let i = 0; i < deals.length; i++) {
                        if ((deals[i].is_active && deals[i].is_active === true)) {
                            finalResult.push(r);
                            break;
                        }
                    }
                }
            });

            const response = {
                success: true,
                results_found: finalResult.length,
                results: finalResult
            }
            return res.status(200).json(response);
        }).catch(err => {
            console.log(err);
            const response = {
                success: false,
                message: 'Something went wrong.'
            }
            return res.status(200).json(response);
        })
    });

});


module.exports = router;